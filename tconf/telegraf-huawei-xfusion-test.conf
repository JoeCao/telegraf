# 华为xFusion Server v7 测试配置
# 简化版配置，用于快速验证连接和基础监控

[agent]
  interval = "30s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  debug = true
  quiet = false

# ====================
# 基础系统监控 (必需)
# ====================
[[inputs.snmp]]
  # SNMP 连接配置 - 请修改为实际设备信息
  agents = ["udp://YOUR_HUAWEI_SERVER_IP:161"]
  timeout = "10s"
  retries = 3
  version = 2
  community = "public"

  [inputs.snmp.tags]
    device_type = "huawei_xfusion_server"
    vendor = "huawei"
    model = "v7"

  # 系统基础信息测试
  [[inputs.snmp.field]]
    name = "system_name"
    oid = "1.3.6.1.2.1.1.5.0"
    conversion = "string"

  [[inputs.snmp.field]]
    name = "system_description"
    oid = "1.3.6.1.2.1.1.1.0"
    conversion = "string"

  [[inputs.snmp.field]]
    name = "system_uptime"
    oid = "1.3.6.1.2.1.1.3.0"
    conversion = "float"

  # 华为专有OID测试
  [[inputs.snmp.field]]
    name = "overall_health_status"
    oid = "1.3.6.1.4.1.58132.2.235.1.1.1.1.0"
    conversion = "int"

  [[inputs.snmp.field]]
    name = "power_on_state"
    oid = "1.3.6.1.4.1.58132.2.235.1.1.1.12.0"
    conversion = "int"

  [[inputs.snmp.field]]
    name = "cpu_utilization"
    oid = "1.3.6.1.4.1.58132.2.235.1.1.1.23.0"
    conversion = "float"

  [[inputs.snmp.field]]
    name = "memory_utilization"
    oid = "1.3.6.1.4.1.58132.2.235.1.1.1.25.0"
    conversion = "float"

# ====================
# CPU发现测试 (一个组件发现)
# ====================
[[inputs.snmp]]
  agents = ["udp://YOUR_HUAWEI_SERVER_IP:161"]
  timeout = "10s"
  retries = 3
  version = 2
  community = "public"

  [inputs.snmp.tags]
    device_type = "huawei_xfusion_server"
    component = "cpu"

  [[inputs.snmp.table]]
    name = "huawei_cpu_test"
    inherit_tags = ["device_type", "component"]

    [[inputs.snmp.table.field]]
      name = "cpu_index"
      oid = "1.3.6.1.4.1.58132.2.235.1.1.15.50.1.1"
      is_tag = true

    [[inputs.snmp.table.field]]
      name = "cpu_name"
      oid = "1.3.6.1.4.1.58132.2.235.1.1.15.50.1.10"
      conversion = "string"
      is_tag = true

    [[inputs.snmp.table.field]]
      name = "cpu_status"
      oid = "1.3.6.1.4.1.58132.2.235.1.1.15.50.1.6"
      conversion = "int"

# ====================
# 连通性测试
# ====================
[[inputs.ping]]
  urls = ["YOUR_HUAWEI_SERVER_IP"]
  count = 3
  timeout = 1.0

  [inputs.ping.tags]
    device_type = "huawei_xfusion_server"
    component = "network"

# ====================
# 数据处理
# ====================
[[processors.starlark]]
  source = '''
def apply(metric):
    # 系统运行时间转换: 百分之一秒 -> 秒
    if "system_uptime" in metric.fields:
        metric.fields["system_uptime"] = metric.fields["system_uptime"] * 0.01
    return metric
'''

[[processors.enum]]
  [[processors.enum.mapping]]
    fields = ["overall_health_status"]
    [processors.enum.mapping.value_mappings]
      1 = "ok"
      2 = "minor"
      3 = "major"
      4 = "critical"
      5 = "absence"
      6 = "unknown"

  [[processors.enum.mapping]]
    fields = ["power_on_state"]
    [processors.enum.mapping.value_mappings]
      1 = "normalPowerOff"
      2 = "powerOn"
      3 = "forcedSystemReset"
      4 = "forcedPowerCycle"
      5 = "forcedPowerOff"

  [[processors.enum.mapping]]
    fields = ["cpu_status"]
    [processors.enum.mapping.value_mappings]
      1 = "ok"
      2 = "minor"
      3 = "major"
      4 = "critical"
      5 = "absence"
      6 = "unknown"

# ====================
# 输出到文件 (用于测试)
# ====================
[[outputs.file]]
  files = ["/tmp/telegraf-huawei-test.out"]
  data_format = "json"
  json_timestamp_units = "1ms"

# 也可以输出到控制台
# [[outputs.stdout]]
#   data_format = "influx"