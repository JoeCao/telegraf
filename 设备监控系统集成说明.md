# 设备监控系统与OneNET IoT平台集成说明

## 概述

本文档说明如何将传统监控配置（如Zabbix）转换为Telegraf配置，并与OneNET IoT平台进行集成，实现设备监控数据的统一采集和上报。

## 1. 配置转换流程

### 1.1 Zabbix配置到Telegraf配置的转换

#### Zabbix配置特点
```yaml
# Zabbix配置示例（YAML格式）
items:
  - name: 'AC: 2.4G 终端数'
    type: SNMP_AGENT
    snmp_oid: 1.3.6.1.4.1.2011.6.139.12.1.2.5.0
    key: 'connect.count[2.4G]'
```

#### Telegraf配置转换
```toml
# 对应的Telegraf配置（TOML格式）
[[inputs.snmp]]
  agents = ["192.168.1.100:161"]
  version = 2
  community = "public"

  [[inputs.snmp.field]]
    name = "ac_2.4g_terminals"
    oid = "1.3.6.1.4.1.2011.6.139.12.1.2.5.0"
```

#### 转换要点
1. **协议转换**: Zabbix的SNMP_AGENT -> Telegraf的inputs.snmp
2. **OID映射**: 保持相同的SNMP OID
3. **命名规范**: 将Zabbix的key转换为Telegraf的field name
4. **数据类型**: 根据实际数据类型设置相应的处理方式

### 1.2 SSH监控配置转换

#### 传统SSH监控方式
```bash
# 手动SSH命令
ssh root@192.168.61.1 'cat /proc/stat'
```

#### Telegraf SSH监控配置
```toml
[[inputs.exec]]
  commands = [
    "sshpass -p 'password' ssh -o StrictHostKeyChecking=no root@192.168.61.1 'cat /proc/stat | head -1'"
  ]
  data_format = "grok"
  grok_patterns = [
    "%{WORD:cpu_name} %{NUMBER:user:int} %{NUMBER:nice:int} %{NUMBER:system:int} %{NUMBER:idle:int}"
  ]
```

## 2. 物模型生成规范

### 2.1 从Telegraf配置生成物模型

#### 分析采集指标
1. **识别数据源**: 确定采集的系统指标类型
2. **提取字段名**: 从processors中提取实际上报的字段
3. **确定数据类型**: 根据指标特性定义合适的数据类型和范围

#### 物模型结构
```json
{
  "properties": [
    {
      "data_type": {
        "specs": {
          "max": 100.0,
          "min": 0.0,
          "unit": "%"
        },
        "type": "float"
      },
      "desc": "CPU使用百分比",
      "identifier": "cpu_usage_percent",
      "name": "CPU使用率"
    }
  ],
  "events": [
    {
      "desc": "CPU使用率过高告警",
      "event_type": "EVENT_TYPE_ALERT",
      "identifier": "high_cpu_usage",
      "name": "CPU使用率过高"
    }
  ]
}
```

### 2.2 数据类型映射规则

| Telegraf数据类型 | 物模型数据类型 | 取值范围示例 |
|------------------|----------------|--------------|
| float (百分比) | float | 0.0-100.0 |
| int (计数器) | int64 | 0-1E15 |
| string (文本) | text | length: 128 |
| 温度值 | float | -20.0-100.0 |

## 3. OneNET平台数据格式适配

### 3.1 标准OneNET格式
```json
{
  "id": "timestamp_metric_name",
  "version": "1.0",
  "params": {
    "property_name": {
      "value": 85.5,
      "time": 1757836022
    }
  }
}
```

### 3.2 Telegraf数据转换处理

#### Starlark处理器配置
```toml
[[processors.starlark]]
  source = '''
def apply(metric):
    current_timestamp = int(metric.time / 1000000000)
    params = {}

    # 将Telegraf字段转换为OneNET格式
    if "cpu_usage_percent" in metric.fields:
        params["cpu_usage_percent"] = {
            "value": float(metric.fields["cpu_usage_percent"]),
            "time": current_timestamp
        }

    # 构建OneNET消息
    onenet_message = {
        "id": str(current_timestamp) + "_" + metric.name,
        "version": "1.0",
        "params": params
    }

    metric.fields["message"] = str(onenet_message)
    return metric
'''
```

### 3.3 MQTT上报配置
```toml
[[outputs.mqtt]]
  servers = ["tcp://121.40.253.229:1883"]
  username = "产品ID"
  password = "访问密钥"
  client_id = "设备ID"
  topic = "$SYS/产品ID/设备ID/property/post"

  data_format = "template"
  template = "{{.Fields.message}}"
```

## 4. 设备类型配置模板

### 4.1 华为AC设备
- **配置文件**: `telegraf-huawei-ac.conf`
- **物模型**: `华为AC物模型.json`
- **采集方式**: SNMP
- **关键指标**: AP数量、终端数、CPU/内存使用率

### 4.2 OpenWrt路由器
- **配置文件**: `telegraf-openwrt-optimized.conf`
- **物模型**: `OpenWrt路由器物模型.json`
- **采集方式**: SSH + sshpass
- **关键指标**: 系统负载、网络流量、DHCP客户端数

### 4.3 WSL2系统监控
- **配置文件**: `telegraf-wsl2-system.conf`
- **物模型**: `WSL2系统监控物模型.json`
- **采集方式**: 本地插件
- **关键指标**: 系统资源、Docker容器状态

## 5. 数据处理和转换规范

### 5.1 数据预处理
```toml
# CPU使用率计算
[[processors.starlark]]
  source = '''
def apply(metric):
    total = user + nice + system + idle + iowait + irq + softirq
    if total > 0:
        metric.fields["cpu_usage_percent"] = float((total - idle) * 100) / total
    return metric
'''
```

### 5.2 单位转换
- **内存**: bytes -> MB (除以1024²)
- **温度**: 毫度 -> 摄氏度 (除以1000)
- **网络流量**: bytes -> Mbps (乘以8再除以1000000)

### 5.3 时间戳处理
```python
# Telegraf时间戳转换为Unix时间戳
current_timestamp = int(metric.time / 1000000000)
```

## 6. 配置优化建议

### 6.1 SSH连接优化
```toml
# 错开采集时间，避免并发连接冲突
collection_jitter = "30s"
timeout = "45s"
interval = "120s"
```

### 6.2 MQTT连接配置
```toml
keep_alive = 60
timeout = "5s"
qos = 1
```

### 6.3 错误处理
```bash
# 命令中添加错误处理
'command 2>/dev/null || echo 0'
```

## 7. 部署和维护

### 7.1 配置文件组织
```
telegraf/
├── tconf/                          # 配置文件目录
│   ├── telegraf-huawei-ac.conf     # 华为AC配置
│   ├── telegraf-openwrt-optimized.conf # OpenWrt配置
│   └── telegraf-wsl2-system.conf   # WSL2配置
├── *.json                          # 物模型文件
└── CLAUDE.md                       # 项目说明
```

### 7.2 调试和测试
```bash
# 测试配置
./telegraf --config tconf/config-name.conf --test

# 运行调试
./telegraf --config tconf/config-name.conf --debug
```

### 7.3 监控检查点
1. **连接测试**: 验证SNMP/SSH连通性
2. **数据格式**: 确认OneNET格式正确性
3. **上报频率**: 监控数据上报间隔
4. **错误日志**: 检查采集失败的原因

## 8. 常见问题解决

### 8.1 SSH连接问题
- **问题**: `kex_exchange_identification: read: Connection reset by peer`
- **解决**: 使用sshpass密码认证，设置合理的超时和重试

### 8.2 SNMP采集问题
- **问题**: SNMP超时或权限拒绝
- **解决**: 检查community字符串，确认SNMP服务状态

### 8.3 数据格式问题
- **问题**: OneNET平台无法识别数据
- **解决**: 检查物模型定义与实际上报字段的一致性

## 9. 扩展指南

### 9.1 添加新设备类型
1. 分析设备的监控接口（SNMP/SSH/API）
2. 创建Telegraf配置文件
3. 定义相应的物模型
4. 配置数据转换处理器
5. 测试和优化

### 9.2 自定义数据处理
```toml
[[processors.starlark]]
  source = '''
def apply(metric):
    # 自定义处理逻辑
    if condition:
        # 数据转换
    return metric
'''
```

---

**注意事项**:
- 确保OneNET平台的产品ID和访问密钥正确配置
- 定期检查设备连接状态和数据上报情况
- 根据实际需求调整采集频率和数据处理逻辑
- 保持配置文件和物模型的同步更新